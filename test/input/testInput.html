<!-- This is a sample page that browses for and reads an epub. -->
<!-- From https://github.com/futurepress/epub.js/blob/master/examples/input.html -->
<!-- Experiment with the input here. -->

<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>EPUB.js Input Example</title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.5/jszip.min.js"></script>

  <!-- New epub.js file which allows for jumps when you go next or prev -->
  <script src="../../modules/epub.js"></script>
  <!-- <script src="../../modules/epub.min.js"></script> -->

  <link rel="stylesheet" type="text/css" href="examples.css">

  <style>
    #book-cover {
      display: none;
    }
    #clear {
      margin: 100px 25px 10px; /* Random margins */
      display: inline-block;
    }
    #recently-opened-books {
      color: blue;
      text-decoration: underline;
    }
    #recently-opened-books:hover {
      cursor: pointer;
    }
    #hidden-viewer {
      display: none;
    }
  </style>

</head>
<body>
  <div id="title"><input type="file" id="input"></div>
  <div id="viewer" class="spreads"></div>

  <!-- Needed for total page calculation -->
  <div id = "hidden-viewer"></div>

  <a id="prev" href="#prev" class="arrow">‹</a>
  <a id="next" href="#next" class="arrow">›</a>
  <input type="button" id="clear">

  <br> <br>
  <img id="book-cover">

  <br> <br>
  <ul id="recently-opened-books"> </ul>

  <script>
  // Global variables tracking state
  // NOTE: May need to make this its own class?
  var book = ePub();
  var rendition;
  var currentPage;
  var totalPages;

  // Utility function
  // https://flaviocopes.com/how-to-list-object-methods-javascript/
  const getMethods = (obj) => {
    let properties = new Set()
    let currentObj = obj
    do {
      Object.getOwnPropertyNames(currentObj).map(item => properties.add(item))
    } while ((currentObj = Object.getPrototypeOf(currentObj)))
    return [...properties.keys()].filter(item => typeof obj[item] === 'function')
  }

  const changeBook = (objURL) => {
    return function() {
      book.destroy();
      rendition.destroy();
      openBook(objURL);
    };
  }

  /// BEGIN MAIN CODE ///

  // var pageListParser = new Pagelist();

  var inputElement = document.getElementById("input");

  const recentlyOpenedBooks = document.querySelector('#recently-opened-books');

  inputElement.addEventListener('change', function (e) {
    var file = e.target.files[0];

    var objectURL = window.URL.createObjectURL(file);

    openBook(objectURL);
  });


  function openBook(objURL) {

    var title = document.getElementById("title");
    var next = document.getElementById("next");
    var prev = document.getElementById("prev");

    // We have to create a new 'book' object every time we load a new book
    // this is because there is no way to unload the book; the book must be
    // destroyed with 'book.destroy()'.
    book = ePub();

    // Because we're using an object URL, we need to specify the "epub"
    // parameter to the open method. If it were a FileReader, we'd use
    // "binary"
    book.open(objURL, "epub");
    book.opened.then(bk => {
      console.log(bk.key())
    });

    /// TEST FUNCTIONS ///

    // Get the sections from the spine
    // LINK: https://github.com/futurepress/epub.js/issues/887
    // book.loaded.spine.then((spine) => {
    //   spine.each((item) => {
    //     item.load(book.load.bind(book)).then((contents) => {
    //       console.log(contents);
    //     });
    //   });
    // });


    // Accesses the book cover.
    // It's a promise, so we must use 'then()' so it displays properly
    // We can also use the url as the src of an image element.

    book.coverUrl().then(url => {
      const bookCover = document.querySelector("#book-cover");
      bookCover.src = url;
    });


    // Get metadata from book
    var bookMetadata = book.loaded.metadata.then(metadata => { return metadata });
    // console.log(`Metadata: ${bookMetadata}`);

    // Push to a list of recently opened books
    let listItem = document.createElement("li");
    bookMetadata.then(metadata => {
      const linkItem = document.createElement("a");
      linkItem.onclick = changeBook(objURL);
      linkItem.innerHTML = metadata.title;
      listItem.appendChild(linkItem);
    }); // Must be in the 'then' function otherwise it will return promise
    recentlyOpenedBooks.appendChild(listItem);


    /// END TEST FUNCTIONS ///

    rendition = book.renderTo("viewer", {
      width: "100%",
      height: 600
    });
    rendition.display();

    // Maybe get pages?


    // The full link has a way to display the TOC
    // LINK: https://github.com/futurepress/epub.js/blob/master/examples/spreads.html
    // book.loaded.navigation.then(function(toc){
    //   // var hiddenRendition = document.querySelector('#hidden-viewer');
    //   totalPages = 0;
    //
    //   // Ensure these settings are the same as rendition
    //   var hiddenRendition = book.renderTo("hidden-viewer", {
    //     width: "100%",
    //     height: 600
    //   });
    //
    //   hiddenRendition.on("relocated", function(location){
    //     totalPages += location.start.displayed.total;
    //   });
    //
    //   toc.forEach(function(chapter) {
    //     hiddenRendition.display(chapter.href);
    //   });
    // });

    /// TEST FUNC ///

    // Clear button to show new book
    var clearButton = document.querySelector('#clear');
    clearButton.value = "Clear";
    clearButton.onclick = () => {
      // NOTE: You must call book.destroy and rendition.destroy()
      book.destroy();
      rendition.destroy();
      next.removeEventListener("click", goNext);
      prev.removeEventListener("click", goPrev);
    }

    /// END TEST FUNC ///

	
	var keyListener = function(e){

      // Left Key
      if ((e.keyCode || e.which) == 37) {
        rendition.prev();
      }

      // Right Key
      if ((e.keyCode || e.which) == 39) {
        rendition.next();
      }

    };

    rendition.on("keyup", keyListener);
    rendition.on("relocated", function(location){
      console.log(location);
    });

    // We must define functions like this so we can remove
    // the event listener when we clear
    function goNext(e) {
      rendition.next();
      e.preventDefault();
    }
    function goPrev(e) {
      rendition.prev();
      e.preventDefault();
    }

    next.addEventListener("click", goNext, false);

    prev.addEventListener("click", goPrev, false);



    document.addEventListener("keyup", keyListener, false);
  }



  </script>

</body>
</html>
