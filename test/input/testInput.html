<!-- This is a sample page that browses for and reads an epub. -->
<!-- From https://github.com/futurepress/epub.js/blob/master/examples/input.html -->
<!-- Experiment with the input here. -->

<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>EPUB.js Input Example</title>

  <script src='../../js/models/BookData.js'></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.5/jszip.min.js"></script>
  <script src="../../modules/epub.min.js"></script>

  <link rel="stylesheet" type="text/css" href="examples.css">

  <style>
    #book-cover {
      display: none;
    }
    #clear {
      margin: 100px 25px 10px; /* Random margins */
      display: inline-block;
    }
    #cleardb {
      margin: 100px 25px 10px; /* Random margins */
      display: none;
    }
    #recently-opened-books {
      color: blue;
      text-decoration: underline;
    }
    #recently-opened-books:hover {
      cursor: pointer;
    }
  </style>

</head>
<body>
  <div id="title"><input type="file" id="input"></div>
  <div id="viewer" class="spreads"></div>
  <a id="prev" href="#prev" class="arrow">‹</a>
  <a id="next" href="#next" class="arrow">›</a>
  <input type="button" id="clear">

  <br> <br>
  <img id="book-cover">

  <br>
  <input type="button" value="Clear Database" id = "cleardb">

  <br>
  <p id = "test-area"></p>

  <br> <br>
  <ul id="recently-opened-books"> </ul>

  <script>
  let db = null;   // IndexedDB
  let bookObjectStore = null; // Also indexedDB; needed cause async
  let currentBook = {};
  let settings = {};
  let settingsStore = null;

  var Book = ePub();
  // var Book = ePub();
  var rendition = null;

  const testArea = document.querySelector('#test-area');
  const recentlyOpenedBooks = document.querySelector('#recently-opened-books');


  // Returns a request for using indexedDB
  var openRequest = indexedDB.open("books");

  openRequest.onupgradeneeded = e => {
    window.alert(`Upgraded database!`);
    // Triggers if client had no database
    // or if the client's database is a lesser version
    // Put initialization code here

    e.target.result.createObjectStore('BOOKS', {keyPath: 'key'});
  }

  openRequest.onerror = e => {
    window.alert(`Error: ${e.target.error}`);
  }

  openRequest.onsuccess = e => {
    window.alert(`Loaded database!`);
    db = e.target.result;

    let dbTransaction = db.transaction('BOOKS', 'readwrite');
    bookObjectStore = dbTransaction.objectStore('BOOKS');
    //
    // let testBook = {
    //   key: '123',
    //   name: 'Something else',
    // };
    //
    // let addRequest = bookObjectStore.put(testBook);

    // Code to run when we update the database.
    // addRequest.onsuccess = e => {
    //   updateRecentlyOpenedBookDisplay(e);
    // }
    // addRequest.onerror = e => {
    //   console.log(`${e.target.error}`);
    // }


    const dbClearButton = document.querySelector('#cleardb');
    dbClearButton.style.display = 'block';

    dbClearButton.onclick = () => {
      indexedDB.deleteDatabase('books');
    }

    updateRecentlyOpenedBookDisplay(bookObjectStore);

    // bookObjectStore.get('123').onsuccess = e => {
    //   console.log(e.target.result);
    //   currentBook = e.target.result;
    //   console.log(currentBook);
    // };
  }

  // Utility function
  // https://flaviocopes.com/how-to-list-object-methods-javascript/
  const getMethods = (obj) => {
    let properties = new Set()
    let currentObj = obj
    do {
      Object.getOwnPropertyNames(currentObj).map(item => properties.add(item))
    } while ((currentObj = Object.getPrototypeOf(currentObj)))
    return [...properties.keys()].filter(item => typeof obj[item] === 'function')
  }

  const changeBook = (objURL) => {
    return function() {
      if (Book) Book.destroy();
      if (rendition) rendition.destroy();
      openBook(objURL);
    };
  }

  // function changeBook(objURL) {
  //   Book.destroy();
  //   rendition.destroy();
  //   openBook(objURL);
  // }

  // function createBookLink(bookObjURL) {
  //
  // }

  function pushToRecentBooks(book) {
    // Push to a list of recently opened books
    // requires global constant recentlyOpenedBooks
    const listItem = document.createElement("li");
    const linkItem = document.createElement("a");
    linkItem.onclick = changeBook(book.bookObjURL);
    linkItem.innerHTML = book.metadata.title;
    listItem.appendChild(linkItem);

    recentlyOpenedBooks.appendChild(listItem);
  }

  function removeChildrenFromElement(element) {
    while (element.firstElementChild)
      element.firstElementChild.remove();
  }

  function updateRecentlyOpenedBookDisplay(objStore) {
    const getAllRequest = objStore.getAll();
    // const getAllRequest = e.target.source.getAll();

    getAllRequest.onsuccess = event => {
      removeChildrenFromElement(recentlyOpenedBooks);
      const arrOfBooks = event.target.result;
      arrOfBooks.forEach(pushToRecentBooks);
    }
  }

  // Used after a book is open with Book.open().
  function getMetadataFromBook(book) {
    return book.packaging.metadata;
  }

  function updateBookToDatabase(arrayBuffer, metadata) {
    if (!db) return;    // Check if the db has been loaded, which is a global variable

    const dbTransaction = db.transaction('BOOKS', 'readwrite');

    // I don't know if bookObjectStore will be needed outside of a function,
    // so I'm leaving a const there cause it would be better if it were there
    /* const */ bookObjectStore = dbTransaction.objectStore('BOOKS');

    // Create the object to add to DB
    const bookData = new BookData(arrayBuffer, metadata);

    let addRequest = bookObjectStore.put(bookData);

    addRequest.onsuccess = e => {
      updateRecentlyOpenedBookDisplay(e.target.source);
    }
    addRequest.onerror = e => {
      console.log(`${e.target.error}`);
    }
  }

  // const changeBook = (objURL, book, rendition) => {
  //   book.destroy();
  //   rendition.destroy();
  //   openBook(objURL);
  // }

  /// BEGIN MAIN CODE ///


  var inputElement = document.getElementById("input");

  inputElement.addEventListener('change', function (e) {
    var file = e.target.files[0];

    // var objectURL = window.URL.createObjectURL(file);
    if (window.FileReader) {
      var reader = new FileReader();
      reader.onload = openBook;
      reader.readAsArrayBuffer(file);
    }

    // openBook(objectURL);
  });

  // Clear button to show new book
  var clearButton = document.querySelector('#clear');
  clearButton.value = "Clear";
  clearButton.onclick = () => {
    // NOTE: You must call book.destroy and rendition.destroy()
    Book.destroy();
    rendition.destroy();
  }


  function openBook(arrayBuffer) {
    console.log(`Objurl: ${arrayBuffer}`);
    console.log(typeof arrayBuffer);

    let BookData = arrayBuffer.target.result;
    currentBook = {};

    var title = document.getElementById("title");
    var next = document.getElementById("next");
    var prev = document.getElementById("prev");

    // We have to create a new 'book' object every time we load a new book
    // this is because there is no way to unload the book; the book must be
    // destroyed with 'book.destroy()'.
    Book = ePub();

    Book.open(BookData, "binary");
    Book.opened.then(bk => {
      currentBook = bk;

      const bookMetadata = getMetadataFromBook(bk);
      updateBookToDatabase(arrayBuffer, bookMetadata);
    });


    /// TEST FUNCTIONS ///

    // Accesses the book cover.
    // It's a promise, so we must use 'then()' so it displays properly
    // We can also use the url as the src of an image element.

    // Book.coverUrl().then(url => {
    //   console.log(`Cover URL: ${url}`);
    //   const bookCover = document.querySelector("#book-cover");
    //   bookCover.src = url;
    // });

    /// END TEST FUNCTIONS ///

    rendition = Book.renderTo("viewer", {
      width: "100%",
      height: 600
    });
    rendition.display();

    /// TEST FUNC ///


    /// END TEST FUNC ///

	
	var keyListener = function(e){

      // Left Key
      if ((e.keyCode || e.which) == 37) {
        rendition.prev();
      }

      // Right Key
      if ((e.keyCode || e.which) == 39) {
        rendition.next();
      }

    };

    rendition.on("keyup", keyListener);
    rendition.on("relocated", function(location){
      console.log(location);
      // console.log(`Current Page: ${location.start.cfi}`);
    });

    // next.removeEventListener("click");
    next.addEventListener("click", function(e){
      rendition.next();
      e.preventDefault();
    }, false);

    // prev.removeEventListener("click");
    prev.addEventListener("click", function(e){
      rendition.prev();
      e.preventDefault();
    }, false);



    // document.removeEventListener("keyup");
    document.addEventListener("keyup", keyListener, false);
  }



  </script>

</body>
</html>
