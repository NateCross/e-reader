<!-- This is a sample page that browses for and reads an epub. -->
<!-- From https://github.com/futurepress/epub.js/blob/master/examples/input.html -->
<!-- Experiment with the input here. -->

<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>EPUB.js Input Example</title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.5/jszip.min.js"></script>
  <script src="../../modules/epub.min.js"></script>

  <link rel="stylesheet" type="text/css" href="examples.css">

  <style>
    #book-cover {
      display: none;
    }
  </style>

</head>
<body>
  <div id="title"><input type="file" id="input"></div>
  <div id="viewer" class="spreads"></div>
  <a id="prev" href="#prev" class="arrow">‹</a>
  <a id="next" href="#next" class="arrow">›</a>

  <br> <br>
  <img id="book-cover">

  <br> <br>
  <ul id="recently-opened-books"> </ul>

  <script>

  var book = ePub();
  var rendition;

  var inputElement = document.getElementById("input");

  const recentlyOpenedBooks = document.querySelector('#recently-opened-books');
  // function pushToRecentlyOpenedBooks(book)

  inputElement.addEventListener('change', function (e) {
        var file = e.target.files[0];
        console.log(file);

        // const objectURL = window.URL.createObjectURL(file);
        // console.log(objectURL);


        // console.log(`File: ${file}`);
        if (window.FileReader) {
            var reader = new FileReader();
            reader.onload = openBook;
            reader.readAsArrayBuffer(file);

        }
    });


  function openBook(e){
    console.log(`e: ${e.target}`);

    var bookData = e.target.result;
    console.log(`Bookdata: ${bookData}`);
    var title = document.getElementById("title");
    var next = document.getElementById("next");
    var prev = document.getElementById("prev");

    book.open(bookData, "binary");

    /// TEST FUNCTIONS ///

    // Accesses the book cover.
    // It's a promise, so we must use 'then()' so it displays properly
    // We can also use the url as the src of an image element.
    book.coverUrl().then(url => {
      console.log(`Cover URL: ${url}`);
      const bookCover = document.querySelector("#book-cover");
      // bookCover.style.display = 'block';
      bookCover.src = url;
    });


    // Get metadata from book
    var bookMetadata = book.loaded.metadata.then(metadata => { return metadata });
    // var bookMetadata = book.loaded.metadata.then(metadata => metadata);
    console.log(`Metadata: ${bookMetadata}`);

    // const objectURL = window.URL.createObjectURL(file);
    // console.log(objectURL);

    // Push to a list of recently opened books
    let listItem = document.createElement("li");
    bookMetadata.then(metadata => {
      listItem.innerText = metadata.title;
    }) // Must be in the 'then' function otherwise it will return promise
    recentlyOpenedBooks.appendChild(listItem);


    /// END TEST FUNCTIONS ///

    rendition = book.renderTo("viewer", {
      width: "100%",
      height: 600
    });

    rendition.display();
	
	var keyListener = function(e){

      // Left Key
      if ((e.keyCode || e.which) == 37) {
        rendition.prev();
      }

      // Right Key
      if ((e.keyCode || e.which) == 39) {
        rendition.next();
      }

    };

    rendition.on("keyup", keyListener);
    rendition.on("relocated", function(location){
      console.log(location);
    });

    next.addEventListener("click", function(e){
      rendition.next();
      e.preventDefault();
    }, false);

    prev.addEventListener("click", function(e){
      rendition.prev();
      e.preventDefault();
    }, false);

    


    document.addEventListener("keyup", keyListener, false);
  }



  </script>

</body>
</html>
